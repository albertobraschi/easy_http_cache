Copyright (c) 2008 Jos√© Valim (jose.valim at gmail dot com)
Site: http://www.pagestacker.com/
Blog: http://josevalim.blogspot.com/
License: MIT
Version: 1.2.2

You can also read this README in pretty html at the GitHub project Wiki page

  http://github.com/josevalim/easy-http-cache/wikis/home

Description
-----------

Allows Rails applications to use HTTP 1.1 cache specifications easily:

  class ListsController < ApplicationController
    http_cache :index, :show
  end

It accepts a wide range of options used to manipulate your cache
headers. Those options usually accepts Proc, Method and Symbols
that are evaluated within the current controller and must return the
specified in which option below. You can also pass Arrays, except when is
said otherwise.

  :last_change_at
    Used to manipulate Last-Modified header.
    It accepts anything that responds to the method :to_time,
    :updated_at or :updated_on, allowing also to pass resources.
    At least, you can pass an Array and it will get the newest time
    from it to compare with the time sent by the client.

  :etag
    Used to manipulate Etag header.
    It accepts anything that responds to the method :to_s.
    Does not accept Array.

  :expires_at
    Used to manipulate Expires header.
    It accepts anything that responds to the method :to_time.
    You can also pass an Array and it will get the closest time to
    the current time and send it to the client.

  :expires_in
    Used to manipulate Expires header.
    It accepts an interval that will be add to Time.now, so it must
    responds to :to_i.
    You can also pass an Array and it will get the closest time to
    the current time and send it to the client.

  If both :expires_in and :expires_at are set, it will get the closest
  time to the current time between both and send it to the client. In
  both options, if a time before the current time is sent, it will be
  discarded.

  :control
    Specifies Cache-Control header.

  :if
    Only perform http cache if the result of the Proc, Method or Symbol is true.

  :unless
    Only perform http cache if the result of the Proc, Method or Symbol is false.

Install
-------

This plugin uses features that only exist on Rails 2.1 and above.
So if you just want a static copy of the plugin:

    cd myapp
    git clone git://github.com/josevalim/easy-http-cache.git vendor/plugins/eash_http_cache
    rm -rf vendor/plugins/easy_http_cache/.git

Examples
--------

Just as above:

  class ListsController < ApplicationController
    http_cache :index, :show
  end

If you do not want to cache json requests, you can simply do:

  class ListsController < ApplicationController
    http_cache :index, :show, :if => Proc.new { |c| !c.request.format.json? }
  end

Another important example (perform cache only if flash is empty):

  class ListsController < ApplicationController
    http_cache :index, :show, :if => Proc.new { |c| c.send(:flash).empty? }
  end

You can easily set Expires header to expire all cache 1 hour after
the request:

  class ListsController < ApplicationController
    http_cache :index, :show, :expires_at => Proc.new { 1.hour.from_now }
  end

Or in an easier way:

  class ListsController < ApplicationController
    http_cache :index, :show, :expires_in => 1.hour
  end

And you can also set :etag header (it also accepts Procs):

  class ListsController < ApplicationController
    http_cache :index, :show, :etag => 'this_will_never_change', :control => :public
  end

All etags will be Digested with MD5, so if you want to use a string,
feel free to put something that matters to you.

Or if you want to expire all http cache before 2008, just do:

  class ListsController < ApplicationController
    http_cache :index, :show, :last_change_at => Time.utc(2008)
  end

Or if you are looking into something more dynamic:

  class ListsController < ApplicationController
    http_cache :index, :show, :last_change_at => Proc.new{ 10.minutes.ago }
  end

How does the last example work?
-------------------------------

The first time http://www.railsapp.com/lists/index is requested, it renders the
action normally but adds a "Last-Modified" to your response with the current
request time, let's suppose 10h30.

If the client do another request at 10h35, the http_cache will check that
:last_change_at and see that the last change was at 10h25, which is older than
the "Last-Modified" field (10h30) returned by the client's browser, so it sends
a "304 Not Modified" response and does not execute the action.

But, if another request from the same client comes at 10h42, the last change was
at 10h32, which is newer than the "Last-Modified" field (10h30), so the action
is performed again and "Last-Modified" field set at 10h42.

More examples
-------------

Now that we understand how it works, we can do even more dynamic caches!

So, if You want to cache a list and automatically expire the cache when
it changes, just do:

  class ListsController < ApplicationController
    http_cache :index, :show, :last_change_at => :list

    protected
    def list
      @list ||= List.find(params[:id])
    end
  end

This will automatically call the list method on your controller, get
the object @list and call updated_at or updated_on on it.

If you are using a resource that doesn't respond to updated_at or updated_on,
you can pass a symbol as parameter in :method, that will be called in your resources:

  class ListsController < ApplicationController
    http_cache :index, :show, :last_change_at => :list, :method => :cached_at

    protected
    def list
      @list ||= List.find(params[:id])
    end
  end

Finally, you can also pass an array at :last_change_at as below:

  class ListsController < ApplicationController
    http_cache :index, :show,
               :last_change_at => [ Time.utc(2007,12,27), Proc.new { 10.minutes.ago } ]
  end

This will check which one is the newest time to compare with the
"Last-Modified" field sent by the client.